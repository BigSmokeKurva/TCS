import { useNavigate } from "react-router-dom";
import { useState, useEffect, useCallback, forwardRef, useImperativeHandle } from "react";
import Cookies from 'js-cookie';
import styles from './header.module.css';
import InfoUserDropdown from "./InfoUserDropdown";
import logoSvg from "../../assets/logo.svg";

const Header = forwardRef((props, ref) => {
    const [username, setUsername] = useState(props.username);
    const [isAdmin, setIsAdmin] = useState((props.page === "admin-panel" || props.page === "invite-codes") ? true : props.isAdmin);
    const [streamerUsername, setStreamerUsername] = useState("");
    const [viewersCount, setViewersCount] = useState(0);
    const [botsCount, setBotsCount] = useState(0);
    const navigate = useNavigate();

    useEffect(() => {
        !username && getUsername();
        (props.page !== "admin-panel" || props.page !== "invite-codes") && isAdmin === undefined && getIsAdmin();
    }, []);

    useImperativeHandle(ref, () => ({
        setStreamerUsername: (username) => setStreamerUsername(username),
        setViewersCount: (count) => setViewersCount(count),
        setBotsCount: (count) => setBotsCount(count),
    }));

    const getUsername = useCallback(async () => {
        var auth_token = Cookies.get('auth_token');
        var response = await fetch('/api/app/getusername', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': auth_token
            }
        });
        if (response.redirected) {
            window.location.href = response.url;
        }
        var result = await response.json();
        setUsername(result.username);
    }, []);

    const getIsAdmin = useCallback(async () => {
        if(props.page === "pause") {
            setIsAdmin(false);
            return;
        }
        var auth_token = Cookies.get('auth_token');
        var response = await fetch('/api/app/getisadmin', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': auth_token
            }
        });
        if (response.redirected) {
            window.location.href = response.url;
        }
        var result = await response.json();
        setIsAdmin(result.isAdmin);
    }, []);


    return (
        <div className={styles.header_container}>
            <div className={styles.logo_container}>
                <img src={logoSvg} />
                <div className={styles.logo_title}>
                    <span>Gnomes</span>
                    <span>Taxi</span>
                </div>
            </div>

            <div className={styles.worker_info}>
                {
                    (props.page === "app" && !props.isMobile) && (
                        <>
                            <div>
                                <span>{streamerUsername}</span>
                                <span>Канал</span>
                            </div>
                            <div>
                                <span>{viewersCount}</span>
                                <span>Зрителей</span>
                            </div>
                            <div>
                                <span>{botsCount}</span>
                                <span>Ботов доступно</span>
                            </div>
                        </>
                    )
                }
            </div>
            {
                isAdmin !== undefined &&
                    props.page === "app" && isAdmin ?
                    <button onClick={() => navigate("/admin-panel")} className={styles.admin_button}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36" fill="none">
                            <path d="M18 1.5L31.5 7.5V16.5C31.5 24.825 25.74 32.61 18 34.5C10.26 32.61 4.5 24.825 4.5 16.5V7.5L18 1.5ZM18 4.77L7.5 9.45V16.83C7.5 23.31 12.375 30 18 31.5C23.625 30 28.5 23.31 28.5 16.83V9.45L18 4.77ZM24 21V23.385C23.94 23.715 23.67 23.94 23.295 24H12.705C12.33 23.94 12.06 23.715 12 23.385V21H24ZM25.5 12L24 19.5H12L10.5 12L14.505 16.005L18 12.51L21.495 16.005L25.5 12Z" fill="#6BB700" />
                        </svg>
                    </button> :
                    (props.page === "admin-panel" || props.page === "invite-codes") &&
                    <button onClick={() => navigate("/app")} className={styles.admin_button}>
                        <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 36 36" fill="none">
                            <path fillRule="evenodd" clipRule="evenodd" d="M15.7935 5.64C13.77 6.378 12.183 8.10375 11.5493 10.2705C10.4235 10.848 9.75 11.58 9.75 12.375C9.75 13.2735 10.608 14.0903 12.0075 14.6947C11.9669 15.5069 12.0917 16.3189 12.3745 17.0813C12.6573 17.8437 13.0922 18.5407 13.6526 19.1299C14.2131 19.7191 14.8874 20.1882 15.6348 20.5088C16.3821 20.8294 17.1868 20.9947 18 20.9947C18.8132 20.9947 19.6179 20.8294 20.3652 20.5088C21.1126 20.1882 21.7869 19.7191 22.3474 19.1299C22.9078 18.5407 23.3427 17.8437 23.6255 17.0813C23.9083 16.3189 24.0331 15.5069 23.9925 14.6947C25.392 14.0903 26.25 13.2735 26.25 12.375C26.25 11.5792 25.5765 10.848 24.45 10.2705C23.817 8.103 22.23 6.378 20.2065 5.63925C20.1259 5.31394 19.9387 5.02499 19.6747 4.8185C19.4107 4.61201 19.0852 4.49988 18.75 4.5H17.25C16.9147 4.49992 16.5891 4.61216 16.3251 4.81879C16.0611 5.02543 15.874 5.31455 15.7935 5.64ZM16.5 9C16.6989 9 16.8897 8.92098 17.0303 8.78033C17.171 8.63968 17.25 8.44891 17.25 8.25V6H18.75V8.25C18.75 8.44891 18.829 8.63968 18.9697 8.78033C19.1103 8.92098 19.3011 9 19.5 9C19.6989 9 19.8897 8.92098 20.0303 8.78033C20.171 8.63968 20.25 8.44891 20.25 8.25V7.2915C21.4403 7.899 22.401 8.98125 22.8937 10.3335C22.8916 10.3422 22.8896 10.351 22.8878 10.3597C22.8504 10.3892 22.811 10.416 22.77 10.44C22.5555 10.5675 22.2015 10.707 21.711 10.8345C20.7412 11.0873 19.4003 11.25 18 11.25C16.5997 11.25 15.2587 11.0873 14.289 10.8345C13.7985 10.707 13.4445 10.5675 13.23 10.44C13.189 10.416 13.1496 10.3892 13.1122 10.3597L13.1108 10.353C13.1094 10.3465 13.1079 10.34 13.1063 10.3335C13.599 8.98125 14.5597 7.89825 15.75 7.2915V8.25C15.75 8.44891 15.829 8.63968 15.9697 8.78033C16.1103 8.92098 16.3011 9 16.5 9ZM12.258 11.5935L12.2333 11.6055C11.778 11.8387 11.5027 12.0608 11.358 12.2265C11.3165 12.2708 11.2817 12.3208 11.2545 12.375C11.2702 12.411 11.316 12.489 11.4412 12.6105C11.676 12.8377 12.0945 13.1115 12.7343 13.3732C14.0063 13.8937 15.8678 14.25 18 14.25C20.1322 14.25 21.9937 13.8938 23.265 13.3725C23.9055 13.1115 24.324 12.8377 24.5588 12.6105C24.684 12.489 24.7297 12.411 24.7455 12.375C24.7183 12.3208 24.6835 12.2708 24.642 12.2265C24.4972 12.0608 24.222 11.8387 23.7668 11.6055L23.742 11.5935C23.6762 11.6417 23.6081 11.6868 23.538 11.7285C23.1503 11.9595 22.6418 12.1425 22.0882 12.2865C20.9708 12.5775 19.5 12.75 18 12.75C16.5 12.75 15.0293 12.5775 13.9117 12.2865C13.3582 12.1425 12.8497 11.9595 12.462 11.7277C12.3919 11.686 12.3238 11.641 12.258 11.5927M24.753 12.3517C24.7523 12.3517 24.7515 12.354 24.7507 12.3593C24.7514 12.3573 24.7519 12.3553 24.7522 12.3533L24.753 12.3517ZM11.2485 12.3563L11.2477 12.3517L11.2492 12.3593L11.2485 12.3563ZM11.2485 12.3923V12.3885V12.3907L11.2477 12.3953L11.2485 12.3923ZM22.4955 15.2048C21.2025 15.5505 19.6575 15.75 18 15.75C16.3425 15.75 14.7975 15.5498 13.5045 15.2055C13.5563 16.363 14.0526 17.4559 14.89 18.2566C15.7274 19.0574 16.8414 19.5043 18 19.5043C19.1586 19.5043 20.2726 19.0574 21.11 18.2566C21.9474 17.4559 22.4437 16.3622 22.4955 15.2048ZM26.0138 19.9455C26.0558 19.8133 26.0603 19.672 26.0268 19.5374C25.9934 19.4028 25.9233 19.2801 25.8243 19.183C25.7252 19.0858 25.6012 19.018 25.466 18.9871C25.3308 18.9563 25.1896 18.9635 25.0583 19.008C24.1889 19.3036 23.4206 19.8386 22.8419 20.5515C22.2632 21.2644 21.8975 22.1262 21.787 23.0378C21.6764 23.9493 21.8254 24.8736 22.2169 25.7042C22.6085 26.5347 23.2265 27.2379 24 27.7327V30.75C24 30.9489 24.079 31.1397 24.2197 31.2803C24.3603 31.421 24.5511 31.5 24.75 31.5H28.5C28.6989 31.5 28.8897 31.421 29.0303 31.2803C29.171 31.1397 29.25 30.9489 29.25 30.75V27.7335C30.0239 27.2388 30.6424 26.5356 31.0342 25.7048C31.426 24.874 31.5752 23.9495 31.4646 23.0376C31.354 22.1258 30.9881 21.2637 30.4091 20.5507C29.8301 19.8376 29.0615 19.3026 28.1917 19.0072C28.0603 18.9626 27.9191 18.9554 27.7837 18.9863C27.6484 19.0172 27.5243 19.0851 27.4253 19.1823C27.3262 19.2796 27.2561 19.4024 27.2227 19.5372C27.1894 19.6719 27.194 19.8133 27.2362 19.9455C27.2428 19.9657 27.2483 19.9862 27.2528 20.007L27.6705 21.957C27.7035 22.1127 27.7013 22.2738 27.6641 22.4286C27.6269 22.5833 27.5556 22.7278 27.4554 22.8515C27.3552 22.9752 27.2287 23.0749 27.085 23.1434C26.9413 23.2119 26.7842 23.2475 26.625 23.2475C26.4658 23.2475 26.3087 23.2119 26.165 23.1434C26.0213 23.0749 25.8948 22.9752 25.7946 22.8515C25.6944 22.7278 25.6231 22.5833 25.5859 22.4286C25.5487 22.2738 25.5465 22.1127 25.5795 21.957L25.9972 20.007C26.0017 19.9862 26.0072 19.9657 26.0138 19.9455ZM29.1367 21.6427L29.0618 21.2887C29.4264 21.6689 29.697 22.129 29.8519 22.6325C30.0068 23.1359 30.0418 23.6686 29.9539 24.1879C29.8661 24.7073 29.6579 25.1989 29.3461 25.6234C29.0342 26.0478 28.6273 26.3934 28.158 26.6325C28.0304 26.6976 27.924 26.7979 27.8516 26.9215C27.7792 27.0451 27.7436 27.1868 27.7493 27.33L27.75 27.375V30H25.5V27.369L25.5007 27.33C25.5064 27.1869 25.471 27.0452 25.3987 26.9216C25.3264 26.798 25.2202 26.6977 25.0928 26.6325C24.6234 26.3934 24.2165 26.0478 23.9047 25.6234C23.5928 25.1989 23.3846 24.7073 23.2968 24.1879C23.209 23.6686 23.2439 23.1359 23.3988 22.6325C23.5538 22.129 23.8244 21.6689 24.189 21.2887L24.1133 21.6427C24.033 22.0173 24.0375 22.405 24.1265 22.7775C24.2155 23.1501 24.3866 23.498 24.6274 23.7958C24.8682 24.0937 25.1726 24.3339 25.5182 24.499C25.8638 24.664 26.242 24.7496 26.625 24.7496C27.008 24.7496 27.3862 24.664 27.7318 24.499C28.0774 24.3339 28.3818 24.0937 28.6226 23.7958C28.8634 23.498 29.0345 23.1501 29.1235 22.7775C29.2125 22.405 29.217 22.0173 29.1367 21.6427ZM13.7648 21.456L17.25 24.1665V26.9227C17.4038 26.9618 17.6438 27 18 27C18.3562 27 18.5962 26.9625 18.75 26.9227V24L20.25 22.875V31.5H4.5V27C4.5 24.2542 9.39 22.2952 13.7648 21.456ZM10.8563 27.201L15.75 26.3857V30H9.75V24.135C10.5715 23.8197 11.4103 23.5517 12.2625 23.3325L10.8563 27.201ZM6 30H8.25V24.8092L8.1945 24.8385C7.3965 25.2615 6.813 25.6928 6.4455 26.0985C6.0855 26.4975 6 26.7922 6 27V30ZM18 28.5C17.7165 28.5 17.4675 28.4812 17.25 28.4497V30H18.75V28.4497C18.5325 28.4812 18.2835 28.5 18 28.5ZM15.7125 24.8708L13.8315 23.4083L13.1437 25.299L15.7125 24.8708Z" fill="#FFAA44" />
                        </svg>
                    </button>
            }
            <InfoUserDropdown username={username} />
        </div>
    )
})

export default Header;